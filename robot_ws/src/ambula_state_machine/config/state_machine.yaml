autonomy_node:
  ros__parameters:
    # -----------------------------
    # main
    # -----------------------------
    tick_period: 0.005
    cmd_vel_topic: "/cmd_vel"
    imu_topic: "/imu/data_raw"
    odom_topic: "/odom/data_raw"
    euler_axes: "sxyz"

    # choose: "pd" or "lqr"
    balance_mode: "pid"

    # -----------------------------
    # feedforward (stand / rocking)
    # -----------------------------
    feedforward:
      control_hz: 100.0
      v_peak: 3.7
      forward_time: 0.10
      backward_time: 0.40
      ramp_time: 0.05
      yaw_rate: 0.0

      # pitch trigger
      use_pitch_trigger: true
      pitch_trigger_deg: 24.0
      pitch_trigger_mode: "either"   # either | positive | negative
      pitch_hold_s: 0.05

      wait_imu_on_start: true        # เริ่มด้วย WAIT_IMU
      imu_wait_timeout_s: 0.5       # IMU ไม่มาเกินนี้ -> เริ่ม profile ได้ แต่ trigger ยังไม่ทำงานจน IMU fresh
      imu_stale_timeout_s: 0.25      # IMU เก่ากว่า 0.25s -> disable trigger ชั่วคราว
      dt_max_scale: 3.0              # clamp dt ถ้า tick หลุด

    # -----------------------------
    # balance: PD gains (used when balance_mode: "pd")
    # -----------------------------
    pidbalance:
      kp_pitch: 1.0          # [m/s per rad]
      ki_pitch: 0.1          # [m/s per rad]
      kd_pitch: 0.01         # [m/s per (rad/s)]
      v_limit: 1.5          # [m/s]
      wz_cmd: 0.0            # keep yaw still
      pitch_soft_deg: 35.0   # safety soft stop (deg)
      pitch_trim_deg: 2.0
      pitch_sign: 1.0
      pitch_rate_sign: 1.0
      v_min: 0.5
      stop_band_deg: 1.0
      stop_rate_deg: 6.0
      min_vel_only_when_need: true

    # -----------------------------
    # balance: LQR params (used when balance_mode: "lqr")
    # ----------------------------- 
    lqrbalance:
      cart_mass: 3.2          # M [kg]
      pendulum_mass: 12.0     # m [kg]
      length_com: 0.2         # l [m]
      inertia: 0.2            # I [kg m^2] (เริ่มที่ 0.2 ก่อน)
      friction: 1.0           # b [N s/m] ใส่คร่าว ๆ ได้
      gravity: 9.81           # g

      # LQR weights (Q,R) - เน้นทรงตัว
      q_x: 0.05               # ถ้า odom x drift เยอะอยู่แล้ว ค่านี้ไม่ต้องสูง
      q_xdot: 1.0
      q_theta: 10.0          # เน้น pitch
      q_theta_dot: 2.0       # เน้นลดการส่ายเร็ว
      r_force: 1.2            # เพิ่ม R ให้ไม่กระชาก

      # Force -> cmd_vel mapping (สำคัญสุดตอนนี้)
      kF: 10.0                # สูงขึ้น = นิ่มขึ้น/สั่นน้อยลง (เริ่ม 55)
      v_limit: 2.0            # ให้สอดคล้องกับ v_limit ใน pdbalance ที่คุณตั้งไว้
      wz_cmd: 0.0

      pitch_soft_deg: 35.0    # ขอแนะนำให้เท่ากับ PD (อย่าใช้ 5 deg)
      pitch_sign: 1.0
      pitch_rate_sign: 1.0
      vx_sign: 1.0

